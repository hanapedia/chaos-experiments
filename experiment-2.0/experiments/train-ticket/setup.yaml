# vim: set filetype=yaml.ansible :
---
- name: Set up chaos experiment
  hosts: localhost
  tasks:
    - name: Prepare directories
      block:
        - name: parent directory for api faults
          ansible.builtin.file:
            path: "./{{ item }}"
            state: directory
            mode: '1777'
          with_items: ['api_faults', 'microservice_faults', 'container_faults']

        - name: get subdirectory names
          ansible.builtin.command: "ls ./datasets/A/{{ item }}"
          register: faults
          changed_when: false
          with_items: ['api_faults', 'microservice_faults', 'container_faults']

        - name: create subdirectories
          ansible.builtin.file:
            path: "./{{ item[0] }}/{{ item[1].split('.')[0] }}"
            state: directory
            mode: '1777'
          with_nested:
            - ['api_faults']
            - "{{ faults.results[0].stdout_lines }}"

        - name: create subdirectories
          ansible.builtin.file:
            path: "./{{ item[0] }}/{{ item[1].split('.')[0] }}"
            state: directory
            mode: '1777'
          with_nested:
            - ['microservice_faults']
            - "{{ faults.results[1].stdout_lines + faults.results[2].stdout_lines }}"

        - name: create subdirectories
          ansible.builtin.file:
            path: "./{{ item[0] }}/{{ item[1].split('.')[0] }}"
            state: directory
            mode: '1777'
          with_nested:
            - ['container_faults']
            - "{{ faults.results[2].stdout_lines }}"

        - name: parent directory for api faults
          ansible.builtin.file:
            path: ./historical_data
            state: directory
            mode: '1777'

