# vim: set filetype=yaml.ansible :
---
- name: Run chaos experiment
  hosts: localhost
  vars:
    history: "-h ./historical_data/3_all_met.pkl -h ./historical_data/4_all_met.pkl"
  tasks:
    - name: get subdirectory names
      ansible.builtin.command: "ls ./datasets/A/{{ item }}"
      register: faults
      changed_when: false
      with_items: ['microservice_faults']

    - name: Run rca for microservice faults
      with_nested:
        - ['microservice_faults_all_metrics']
        - "{{ faults.results[0].stdout_lines }}"
      vars:
        path_root: "./{{ item[0] }}/{{ item[1].split('.')[0] }}"
      ansible.builtin.command:
        creates: "{{ path_root }}/results.pkl"
        cmd: "python ./files/run_tracerca.py -p {{ path_root }} -i {{ path_root }}/invocation.pkl -o {{ path_root }}/results.pkl {{ history }} -l {{ path_root }}/result.log -a"
